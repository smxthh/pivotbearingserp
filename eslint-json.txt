[{"filePath":"D:\\pivotbearings-erp\\src\\components\\purchase\\PurchaseOrderDialog.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'defaultPrefix', 'form', 'getNextPoNumber', 'getPurchaseOrderWithItems', and 'today'. Either include them or remove the dependency array.","line":170,"column":8,"nodeType":"ArrayExpression","endLine":170,"endColumn":21,"suggestions":[{"desc":"Update the dependencies array to be: [defaultPrefix, form, getNextPoNumber, getPurchaseOrderWithItems, open, order, today]","fix":{"range":[5688,5701],"text":"[defaultPrefix, form, getNextPoNumber, getPurchaseOrderWithItems, open, order, today]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react';\r\nimport { useForm, useFieldArray } from 'react-hook-form';\r\nimport { zodResolver } from '@hookform/resolvers/zod';\r\nimport { z } from 'zod';\r\nimport { ShoppingCart, Save, X, Plus, Trash2 } from 'lucide-react';\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogHeader,\r\n    DialogTitle,\r\n} from '@/components/ui/dialog';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport {\r\n    Form,\r\n    FormControl,\r\n    FormField,\r\n    FormItem,\r\n    FormLabel,\r\n    FormMessage,\r\n} from '@/components/ui/form';\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from '@/components/ui/select';\r\nimport {\r\n    usePurchaseOrders,\r\n    useSuppliers,\r\n    getCurrentFYPrefix,\r\n    PurchaseOrder,\r\n    PurchaseOrderItem,\r\n} from '@/hooks/usePurchaseOrders';\r\nimport { useItems } from '@/hooks/useItems';\r\n\r\n// Item schema\r\nconst itemSchema = z.object({\r\n    item_id: z.string().nullable(),\r\n    item_name: z.string().min(1, 'Item name is required'),\r\n    hsn_code: z.string(),\r\n    quantity: z.coerce.number().min(0.001, 'Quantity must be greater than 0'),\r\n    unit: z.string(),\r\n    price: z.coerce.number().min(0),\r\n    discount_percent: z.coerce.number().min(0).max(100),\r\n    discount_amount: z.coerce.number().min(0),\r\n    gst_percent: z.coerce.number().min(0).max(100),\r\n    cgst_percent: z.coerce.number().min(0),\r\n    sgst_percent: z.coerce.number().min(0),\r\n    igst_percent: z.coerce.number().min(0),\r\n    cgst_amount: z.coerce.number().min(0),\r\n    sgst_amount: z.coerce.number().min(0),\r\n    igst_amount: z.coerce.number().min(0),\r\n    taxable_amount: z.coerce.number().min(0),\r\n    net_amount: z.coerce.number().min(0),\r\n    remark: z.string(),\r\n});\r\n\r\n// Main form schema\r\nconst purchaseOrderSchema = z.object({\r\n    po_prefix: z.string(),\r\n    po_number: z.coerce.number().min(1),\r\n    po_date: z.string().min(1, 'Date is required'),\r\n    party_id: z.string().min(1, 'Party is required'),\r\n    party_gstin: z.string().optional(),\r\n    transport_name: z.string().optional(),\r\n    contact_person: z.string().optional(),\r\n    contact_number: z.string().optional(),\r\n    delivery_address: z.string().optional(),\r\n    gst_type: z.coerce.number().default(1),\r\n    remark: z.string().optional(),\r\n    items: z.array(itemSchema),\r\n});\r\n\r\ntype PurchaseOrderFormData = z.infer<typeof purchaseOrderSchema>;\r\n\r\ninterface PurchaseOrderDialogProps {\r\n    open: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n    order?: PurchaseOrder | null;\r\n    onSuccess?: () => void;\r\n}\r\n\r\nexport function PurchaseOrderDialog({\r\n    open,\r\n    onOpenChange,\r\n    order,\r\n    onSuccess,\r\n}: PurchaseOrderDialogProps) {\r\n    const isEdit = !!order;\r\n    const [isSaving, setIsSaving] = useState(false);\r\n\r\n    const { createPurchaseOrder, updatePurchaseOrder, getNextPoNumber, getPurchaseOrderWithItems } =\r\n        usePurchaseOrders();\r\n    const { suppliers } = useSuppliers();\r\n    const { items: productItems } = useItems();\r\n\r\n    const defaultPrefix = getCurrentFYPrefix();\r\n    const today = new Date().toISOString().split('T')[0];\r\n\r\n    const form = useForm<PurchaseOrderFormData>({\r\n        resolver: zodResolver(purchaseOrderSchema),\r\n        defaultValues: {\r\n            po_prefix: defaultPrefix,\r\n            po_number: 1,\r\n            po_date: today,\r\n            party_id: '',\r\n            party_gstin: '',\r\n            transport_name: '',\r\n            contact_person: '',\r\n            contact_number: '',\r\n            delivery_address: '',\r\n            gst_type: 1,\r\n            remark: '',\r\n            items: [],\r\n        },\r\n    });\r\n\r\n    const { fields, append, remove } = useFieldArray({\r\n        control: form.control,\r\n        name: 'items',\r\n    });\r\n\r\n    // Initialize form when opening\r\n    useEffect(() => {\r\n        const initForm = async () => {\r\n            if (order) {\r\n                // Edit mode - fetch full order with items\r\n                const fullOrder = await getPurchaseOrderWithItems(order.id);\r\n                if (fullOrder) {\r\n                    form.reset({\r\n                        po_prefix: fullOrder.po_prefix,\r\n                        po_number: fullOrder.po_number,\r\n                        po_date: fullOrder.po_date,\r\n                        party_id: fullOrder.party_id,\r\n                        party_gstin: fullOrder.party_gstin || '',\r\n                        transport_name: fullOrder.transport_name || '',\r\n                        contact_person: fullOrder.contact_person || '',\r\n                        contact_number: fullOrder.contact_number || '',\r\n                        delivery_address: fullOrder.delivery_address || '',\r\n                        gst_type: fullOrder.gst_type,\r\n                        remark: fullOrder.remark || '',\r\n                        items: fullOrder.items || [],\r\n                    });\r\n                }\r\n            } else {\r\n                // New order - get next PO number\r\n                const nextNum = await getNextPoNumber(defaultPrefix);\r\n                form.reset({\r\n                    po_prefix: defaultPrefix,\r\n                    po_number: nextNum,\r\n                    po_date: today,\r\n                    party_id: '',\r\n                    party_gstin: '',\r\n                    transport_name: '',\r\n                    contact_person: '',\r\n                    contact_number: '',\r\n                    delivery_address: '',\r\n                    gst_type: 1,\r\n                    remark: '',\r\n                    items: [],\r\n                });\r\n            }\r\n        };\r\n\r\n        if (open) {\r\n            initForm();\r\n        }\r\n    }, [open, order]);\r\n\r\n    // Calculate item amounts\r\n    const calculateItemAmounts = (index: number) => {\r\n        const items = form.getValues('items');\r\n        const item = items[index];\r\n        const gstType = form.getValues('gst_type');\r\n\r\n        const qty = item.quantity || 0;\r\n        const price = item.price || 0;\r\n        const discPercent = item.discount_percent || 0;\r\n        const gstPercent = item.gst_percent || 0;\r\n\r\n        // Calculate base amount\r\n        const baseAmount = qty * price;\r\n        const discAmount = (baseAmount * discPercent) / 100;\r\n        const taxableAmount = baseAmount - discAmount;\r\n\r\n        // Calculate tax based on GST type\r\n        let cgstAmt = 0,\r\n            sgstAmt = 0,\r\n            igstAmt = 0;\r\n        let cgstPer = 0,\r\n            sgstPer = 0,\r\n            igstPer = 0;\r\n\r\n        if (gstType === 1) {\r\n            // Local - CGST + SGST (split equally)\r\n            cgstPer = gstPercent / 2;\r\n            sgstPer = gstPercent / 2;\r\n            cgstAmt = (taxableAmount * cgstPer) / 100;\r\n            sgstAmt = (taxableAmount * sgstPer) / 100;\r\n        } else {\r\n            // Central - IGST\r\n            igstPer = gstPercent;\r\n            igstAmt = (taxableAmount * igstPer) / 100;\r\n        }\r\n\r\n        const netAmount = taxableAmount + cgstAmt + sgstAmt + igstAmt;\r\n\r\n        // Update form values\r\n        form.setValue(`items.${index}.discount_amount`, parseFloat(discAmount.toFixed(2)));\r\n        form.setValue(`items.${index}.taxable_amount`, parseFloat(taxableAmount.toFixed(2)));\r\n        form.setValue(`items.${index}.cgst_percent`, cgstPer);\r\n        form.setValue(`items.${index}.sgst_percent`, sgstPer);\r\n        form.setValue(`items.${index}.igst_percent`, igstPer);\r\n        form.setValue(`items.${index}.cgst_amount`, parseFloat(cgstAmt.toFixed(2)));\r\n        form.setValue(`items.${index}.sgst_amount`, parseFloat(sgstAmt.toFixed(2)));\r\n        form.setValue(`items.${index}.igst_amount`, parseFloat(igstAmt.toFixed(2)));\r\n        form.setValue(`items.${index}.net_amount`, parseFloat(netAmount.toFixed(2)));\r\n    };\r\n\r\n    // Calculate totals\r\n    const calculateTotals = () => {\r\n        const items = form.getValues('items');\r\n        let taxable = 0,\r\n            cgst = 0,\r\n            sgst = 0,\r\n            igst = 0,\r\n            net = 0;\r\n\r\n        items.forEach((item) => {\r\n            taxable += item.taxable_amount || 0;\r\n            cgst += item.cgst_amount || 0;\r\n            sgst += item.sgst_amount || 0;\r\n            igst += item.igst_amount || 0;\r\n            net += item.net_amount || 0;\r\n        });\r\n\r\n        // Round off\r\n        const roundedNet = Math.round(net);\r\n        const roundOff = roundedNet - net;\r\n\r\n        return {\r\n            taxable_amount: parseFloat(taxable.toFixed(2)),\r\n            cgst_amount: parseFloat(cgst.toFixed(2)),\r\n            sgst_amount: parseFloat(sgst.toFixed(2)),\r\n            igst_amount: parseFloat(igst.toFixed(2)),\r\n            round_off_amount: parseFloat(roundOff.toFixed(2)),\r\n            net_amount: roundedNet,\r\n        };\r\n    };\r\n\r\n    // Add new item row\r\n    const addItem = () => {\r\n        append({\r\n            item_id: null,\r\n            item_name: '',\r\n            hsn_code: '',\r\n            quantity: 1,\r\n            unit: 'PCS',\r\n            price: 0,\r\n            discount_percent: 0,\r\n            discount_amount: 0,\r\n            gst_percent: 18,\r\n            cgst_percent: 9,\r\n            sgst_percent: 9,\r\n            igst_percent: 0,\r\n            cgst_amount: 0,\r\n            sgst_amount: 0,\r\n            igst_amount: 0,\r\n            taxable_amount: 0,\r\n            net_amount: 0,\r\n            remark: '',\r\n        });\r\n    };\r\n\r\n    // Handle item selection from dropdown\r\n    const handleItemSelect = (index: number, itemId: string) => {\r\n        const selectedItem = productItems.find((i) => i.id === itemId);\r\n        if (selectedItem) {\r\n            form.setValue(`items.${index}.item_id`, itemId);\r\n            form.setValue(`items.${index}.item_name`, selectedItem.name);\r\n            form.setValue(`items.${index}.hsn_code`, selectedItem.hsn_code || '');\r\n            form.setValue(`items.${index}.unit`, selectedItem.unit || 'PCS');\r\n            form.setValue(`items.${index}.gst_percent`, selectedItem.gst_percent || 0);\r\n            form.setValue(`items.${index}.price`, selectedItem.purchase_price || selectedItem.sale_price || 0);\r\n            calculateItemAmounts(index);\r\n        }\r\n    };\r\n\r\n    // Handle party selection\r\n    const handlePartySelect = (partyId: string) => {\r\n        form.setValue('party_id', partyId);\r\n        const selectedParty = suppliers.find((s) => s.id === partyId);\r\n        if (selectedParty) {\r\n            form.setValue('party_gstin', selectedParty.gstin || '');\r\n            // Set GST type based on state\r\n            // If party is in same state as distributor, use Local (CGST+SGST)\r\n            // Otherwise use Central (IGST)\r\n            // For now, default to Local\r\n        }\r\n    };\r\n\r\n    const onSubmit = async (data: PurchaseOrderFormData) => {\r\n        setIsSaving(true);\r\n        try {\r\n            const totals = calculateTotals();\r\n            const poFullNumber = `${data.po_prefix}${data.po_number}`;\r\n\r\n            const orderData = {\r\n                po_prefix: data.po_prefix,\r\n                po_number: data.po_number,\r\n                po_full_number: poFullNumber,\r\n                po_date: data.po_date,\r\n                party_id: data.party_id,\r\n                party_gstin: data.party_gstin,\r\n                transport_name: data.transport_name,\r\n                contact_person: data.contact_person,\r\n                contact_number: data.contact_number,\r\n                delivery_address: data.delivery_address,\r\n                gst_type: data.gst_type,\r\n                remark: data.remark,\r\n                ...totals,\r\n                items: data.items,\r\n            };\r\n\r\n            if (isEdit && order) {\r\n                await updatePurchaseOrder.mutateAsync({ id: order.id, data: orderData });\r\n            } else {\r\n                await createPurchaseOrder.mutateAsync(orderData);\r\n            }\r\n\r\n            onOpenChange(false);\r\n            onSuccess?.();\r\n        } catch (error) {\r\n            console.error('Error saving purchase order:', error);\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    const totals = calculateTotals();\r\n    const gstType = form.watch('gst_type');\r\n\r\n    return (\r\n        <Dialog open={open} onOpenChange={onOpenChange}>\r\n            <DialogContent className=\"max-w-6xl max-h-[95vh] overflow-y-auto\">\r\n                <DialogHeader>\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center\">\r\n                            <ShoppingCart className=\"h-5 w-5 text-primary\" />\r\n                        </div>\r\n                        <DialogTitle className=\"text-xl\">\r\n                            {isEdit ? 'Edit Purchase Order' : 'Purchase Order'}\r\n                        </DialogTitle>\r\n                    </div>\r\n                </DialogHeader>\r\n\r\n                <Form {...form}>\r\n                    <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6 pt-4\">\r\n                        {/* Row 1: PO No, Date, Party, GST No */}\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-12 gap-4\">\r\n                            {/* PO Number */}\r\n                            <div className=\"col-span-12 md:col-span-2\">\r\n                                <FormLabel>PO. No.</FormLabel>\r\n                                <div className=\"flex gap-1\">\r\n                                    <FormField\r\n                                        control={form.control}\r\n                                        name=\"po_prefix\"\r\n                                        render={({ field }) => (\r\n                                            <Select onValueChange={field.onChange} value={field.value}>\r\n                                                <SelectTrigger className=\"w-24\">\r\n                                                    <SelectValue />\r\n                                                </SelectTrigger>\r\n                                                <SelectContent>\r\n                                                    <SelectItem value={defaultPrefix}>{defaultPrefix}</SelectItem>\r\n                                                </SelectContent>\r\n                                            </Select>\r\n                                        )}\r\n                                    />\r\n                                    <FormField\r\n                                        control={form.control}\r\n                                        name=\"po_number\"\r\n                                        render={({ field }) => (\r\n                                            <Input\r\n                                                type=\"number\"\r\n                                                className=\"w-16\"\r\n                                                {...field}\r\n                                                onWheel={(e) => e.currentTarget.blur()}\r\n                                            />\r\n                                        )}\r\n                                    />\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* PO Date */}\r\n                            <div className=\"col-span-12 md:col-span-2\">\r\n                                <FormField\r\n                                    control={form.control}\r\n                                    name=\"po_date\"\r\n                                    render={({ field }) => (\r\n                                        <FormItem>\r\n                                            <FormLabel>\r\n                                                PO. Date <span className=\"text-red-500\">*</span>\r\n                                            </FormLabel>\r\n                                            <FormControl>\r\n                                                <Input type=\"date\" {...field} />\r\n                                            </FormControl>\r\n                                            <FormMessage />\r\n                                        </FormItem>\r\n                                    )}\r\n                                />\r\n                            </div>\r\n\r\n                            {/* Party Name */}\r\n                            <div className=\"col-span-12 md:col-span-5\">\r\n                                <FormField\r\n                                    control={form.control}\r\n                                    name=\"party_id\"\r\n                                    render={({ field }) => (\r\n                                        <FormItem>\r\n                                            <FormLabel>\r\n                                                Party Name <span className=\"text-red-500\">*</span>\r\n                                            </FormLabel>\r\n                                            <Select onValueChange={handlePartySelect} value={field.value}>\r\n                                                <FormControl>\r\n                                                    <SelectTrigger>\r\n                                                        <SelectValue placeholder=\"Select Party\" />\r\n                                                    </SelectTrigger>\r\n                                                </FormControl>\r\n                                                <SelectContent>\r\n                                                    {suppliers.map((s) => (\r\n                                                        <SelectItem key={s.id} value={s.id}>\r\n                                                            {s.name} {s.city ? `(${s.city})` : ''}\r\n                                                        </SelectItem>\r\n                                                    ))}\r\n                                                </SelectContent>\r\n                                            </Select>\r\n                                            <FormMessage />\r\n                                        </FormItem>\r\n                                    )}\r\n                                />\r\n                            </div>\r\n\r\n                            {/* GST No */}\r\n                            <div className=\"col-span-12 md:col-span-3\">\r\n                                <FormField\r\n                                    control={form.control}\r\n                                    name=\"party_gstin\"\r\n                                    render={({ field }) => (\r\n                                        <FormItem>\r\n                                            <FormLabel>GST NO.</FormLabel>\r\n                                            <FormControl>\r\n                                                <Input placeholder=\"GST Number\" {...field} />\r\n                                            </FormControl>\r\n                                            <FormMessage />\r\n                                        </FormItem>\r\n                                    )}\r\n                                />\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Row 2: Transport, Contact Person, Contact No */}\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-12 gap-4\">\r\n                            <div className=\"col-span-12 md:col-span-4\">\r\n                                <FormField\r\n                                    control={form.control}\r\n                                    name=\"transport_name\"\r\n                                    render={({ field }) => (\r\n                                        <FormItem>\r\n                                            <FormLabel>Transport Name</FormLabel>\r\n                                            <FormControl>\r\n                                                <Input placeholder=\"Transport Name\" {...field} />\r\n                                            </FormControl>\r\n                                        </FormItem>\r\n                                    )}\r\n                                />\r\n                            </div>\r\n\r\n                            <div className=\"col-span-12 md:col-span-4\">\r\n                                <FormField\r\n                                    control={form.control}\r\n                                    name=\"contact_person\"\r\n                                    render={({ field }) => (\r\n                                        <FormItem>\r\n                                            <FormLabel>Contact Person</FormLabel>\r\n                                            <FormControl>\r\n                                                <Input placeholder=\"Contact Person\" {...field} />\r\n                                            </FormControl>\r\n                                        </FormItem>\r\n                                    )}\r\n                                />\r\n                            </div>\r\n\r\n                            <div className=\"col-span-12 md:col-span-4\">\r\n                                <FormField\r\n                                    control={form.control}\r\n                                    name=\"contact_number\"\r\n                                    render={({ field }) => (\r\n                                        <FormItem>\r\n                                            <FormLabel>Contact No.</FormLabel>\r\n                                            <FormControl>\r\n                                                <Input placeholder=\"Contact No.\" {...field} />\r\n                                            </FormControl>\r\n                                        </FormItem>\r\n                                    )}\r\n                                />\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Row 3: Delivery Address */}\r\n                        <div className=\"grid grid-cols-1 gap-4\">\r\n                            <FormField\r\n                                control={form.control}\r\n                                name=\"delivery_address\"\r\n                                render={({ field }) => (\r\n                                    <FormItem>\r\n                                        <FormLabel>Delivery Address</FormLabel>\r\n                                        <FormControl>\r\n                                            <Input placeholder=\"Delivery Address\" {...field} />\r\n                                        </FormControl>\r\n                                    </FormItem>\r\n                                )}\r\n                            />\r\n                        </div>\r\n\r\n                        <hr />\r\n\r\n                        {/* Item Details Header */}\r\n                        <div className=\"flex items-center justify-between\">\r\n                            <h4 className=\"font-semibold\">Item Details :</h4>\r\n                            <Button type=\"button\" variant=\"outline\" size=\"sm\" onClick={addItem}>\r\n                                <Plus className=\"h-4 w-4 mr-2\" />\r\n                                Add Item\r\n                            </Button>\r\n                        </div>\r\n\r\n                        {/* Items Table */}\r\n                        <div className=\"border rounded-lg overflow-x-auto\">\r\n                            <table className=\"w-full text-sm\">\r\n                                <thead className=\"bg-gray-800 text-white\">\r\n                                    <tr>\r\n                                        <th className=\"px-2 py-2 text-left w-8\">#</th>\r\n                                        <th className=\"px-2 py-2 text-left min-w-[200px]\">Item Name</th>\r\n                                        <th className=\"px-2 py-2 text-left w-20\">HSN Code</th>\r\n                                        <th className=\"px-2 py-2 text-right w-16\">Qty.</th>\r\n                                        <th className=\"px-2 py-2 text-left w-16\">UOM</th>\r\n                                        <th className=\"px-2 py-2 text-right w-20\">Price</th>\r\n                                        <th className=\"px-2 py-2 text-right w-16\">Disc.</th>\r\n                                        {gstType === 1 ? (\r\n                                            <>\r\n                                                <th className=\"px-2 py-2 text-right w-16\">CGST</th>\r\n                                                <th className=\"px-2 py-2 text-right w-16\">SGST</th>\r\n                                            </>\r\n                                        ) : (\r\n                                            <th className=\"px-2 py-2 text-right w-16\">IGST</th>\r\n                                        )}\r\n                                        <th className=\"px-2 py-2 text-right w-24\">Amount</th>\r\n                                        <th className=\"px-2 py-2 text-left w-24\">Remark</th>\r\n                                        <th className=\"px-2 py-2 text-center w-16\">Action</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    {fields.length === 0 ? (\r\n                                        <tr>\r\n                                            <td colSpan={12} className=\"text-center py-8 text-muted-foreground\">\r\n                                                No data available in table\r\n                                            </td>\r\n                                        </tr>\r\n                                    ) : (\r\n                                        fields.map((field, index) => (\r\n                                            <tr key={field.id} className=\"border-b\">\r\n                                                <td className=\"px-2 py-2\">{index + 1}</td>\r\n                                                <td className=\"px-2 py-2\">\r\n                                                    <Select\r\n                                                        value={form.watch(`items.${index}.item_id`) || ''}\r\n                                                        onValueChange={(v) => handleItemSelect(index, v)}\r\n                                                    >\r\n                                                        <SelectTrigger className=\"h-8 text-xs\">\r\n                                                            <SelectValue placeholder=\"Select Item\" />\r\n                                                        </SelectTrigger>\r\n                                                        <SelectContent>\r\n                                                            {productItems.map((item) => (\r\n                                                                <SelectItem key={item.id} value={item.id}>\r\n                                                                    {item.name}\r\n                                                                </SelectItem>\r\n                                                            ))}\r\n                                                        </SelectContent>\r\n                                                    </Select>\r\n                                                </td>\r\n                                                <td className=\"px-2 py-2\">\r\n                                                    <Input\r\n                                                        className=\"h-8 text-xs w-20\"\r\n                                                        {...form.register(`items.${index}.hsn_code`)}\r\n                                                    />\r\n                                                </td>\r\n                                                <td className=\"px-2 py-2\">\r\n                                                    <Input\r\n                                                        type=\"number\"\r\n                                                        className=\"h-8 text-xs w-16 text-right\"\r\n                                                        {...form.register(`items.${index}.quantity`)}\r\n                                                        onBlur={() => calculateItemAmounts(index)}\r\n                                                        onWheel={(e) => e.currentTarget.blur()}\r\n                                                    />\r\n                                                </td>\r\n                                                <td className=\"px-2 py-2\">\r\n                                                    <Input\r\n                                                        className=\"h-8 text-xs w-16\"\r\n                                                        {...form.register(`items.${index}.unit`)}\r\n                                                    />\r\n                                                </td>\r\n                                                <td className=\"px-2 py-2\">\r\n                                                    <Input\r\n                                                        type=\"number\"\r\n                                                        className=\"h-8 text-xs w-20 text-right\"\r\n                                                        {...form.register(`items.${index}.price`)}\r\n                                                        onBlur={() => calculateItemAmounts(index)}\r\n                                                        onWheel={(e) => e.currentTarget.blur()}\r\n                                                    />\r\n                                                </td>\r\n                                                <td className=\"px-2 py-2\">\r\n                                                    <Input\r\n                                                        type=\"number\"\r\n                                                        className=\"h-8 text-xs w-16 text-right\"\r\n                                                        {...form.register(`items.${index}.discount_percent`)}\r\n                                                        onBlur={() => calculateItemAmounts(index)}\r\n                                                        onWheel={(e) => e.currentTarget.blur()}\r\n                                                    />\r\n                                                </td>\r\n                                                {gstType === 1 ? (\r\n                                                    <>\r\n                                                        <td className=\"px-2 py-2 text-right text-xs\">\r\n                                                            {form.watch(`items.${index}.cgst_amount`)?.toFixed(2) || '0.00'}\r\n                                                        </td>\r\n                                                        <td className=\"px-2 py-2 text-right text-xs\">\r\n                                                            {form.watch(`items.${index}.sgst_amount`)?.toFixed(2) || '0.00'}\r\n                                                        </td>\r\n                                                    </>\r\n                                                ) : (\r\n                                                    <td className=\"px-2 py-2 text-right text-xs\">\r\n                                                        {form.watch(`items.${index}.igst_amount`)?.toFixed(2) || '0.00'}\r\n                                                    </td>\r\n                                                )}\r\n                                                <td className=\"px-2 py-2 text-right text-xs font-medium\">\r\n                                                    {form.watch(`items.${index}.net_amount`)?.toFixed(2) || '0.00'}\r\n                                                </td>\r\n                                                <td className=\"px-2 py-2\">\r\n                                                    <Input\r\n                                                        className=\"h-8 text-xs w-24\"\r\n                                                        {...form.register(`items.${index}.remark`)}\r\n                                                    />\r\n                                                </td>\r\n                                                <td className=\"px-2 py-2 text-center\">\r\n                                                    <Button\r\n                                                        type=\"button\"\r\n                                                        variant=\"ghost\"\r\n                                                        size=\"icon\"\r\n                                                        className=\"h-7 w-7 text-destructive\"\r\n                                                        onClick={() => remove(index)}\r\n                                                    >\r\n                                                        <Trash2 className=\"h-4 w-4\" />\r\n                                                    </Button>\r\n                                                </td>\r\n                                            </tr>\r\n                                        ))\r\n                                    )}\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n\r\n                        <hr />\r\n\r\n                        {/* Summary Table */}\r\n                        <div className=\"border rounded-lg overflow-hidden\">\r\n                            <table className=\"w-full text-sm\">\r\n                                <thead className=\"bg-gray-800 text-white\">\r\n                                    <tr>\r\n                                        <th className=\"px-4 py-2 text-left w-1/3\">Description</th>\r\n                                        <th className=\"px-4 py-2 text-right w-1/6\">Percentage</th>\r\n                                        <th className=\"px-4 py-2 text-right w-1/6\">Amount</th>\r\n                                        <th className=\"px-4 py-2 text-right w-1/3\">Net Amount</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody>\r\n                                    <tr className=\"border-b\">\r\n                                        <td className=\"px-4 py-2\">Sub Total</td>\r\n                                        <td className=\"px-4 py-2\"></td>\r\n                                        <td className=\"px-4 py-2\"></td>\r\n                                        <td className=\"px-4 py-2 text-right font-medium\">\r\n                                            {totals.taxable_amount.toFixed(3)}\r\n                                        </td>\r\n                                    </tr>\r\n                                    {gstType === 1 ? (\r\n                                        <>\r\n                                            <tr className=\"border-b\">\r\n                                                <td className=\"px-4 py-2\">CGST</td>\r\n                                                <td className=\"px-4 py-2\"></td>\r\n                                                <td className=\"px-4 py-2\"></td>\r\n                                                <td className=\"px-4 py-2 text-right\">\r\n                                                    {totals.cgst_amount.toFixed(3)}\r\n                                                </td>\r\n                                            </tr>\r\n                                            <tr className=\"border-b\">\r\n                                                <td className=\"px-4 py-2\">SGST</td>\r\n                                                <td className=\"px-4 py-2\"></td>\r\n                                                <td className=\"px-4 py-2\"></td>\r\n                                                <td className=\"px-4 py-2 text-right\">\r\n                                                    {totals.sgst_amount.toFixed(3)}\r\n                                                </td>\r\n                                            </tr>\r\n                                        </>\r\n                                    ) : (\r\n                                        <tr className=\"border-b\">\r\n                                            <td className=\"px-4 py-2\">IGST</td>\r\n                                            <td className=\"px-4 py-2\"></td>\r\n                                            <td className=\"px-4 py-2\"></td>\r\n                                            <td className=\"px-4 py-2 text-right\">\r\n                                                {totals.igst_amount.toFixed(3)}\r\n                                            </td>\r\n                                        </tr>\r\n                                    )}\r\n                                    <tr className=\"border-b\">\r\n                                        <td className=\"px-4 py-2\">ROUNDED OFF</td>\r\n                                        <td className=\"px-4 py-2\"></td>\r\n                                        <td className=\"px-4 py-2\"></td>\r\n                                        <td className=\"px-4 py-2 text-right\">\r\n                                            {totals.round_off_amount.toFixed(3)}\r\n                                        </td>\r\n                                    </tr>\r\n                                </tbody>\r\n                                <tfoot className=\"bg-gray-800 text-white\">\r\n                                    <tr>\r\n                                        <th className=\"px-4 py-2 text-left\">Net. Amount</th>\r\n                                        <th className=\"px-4 py-2\"></th>\r\n                                        <th className=\"px-4 py-2\"></th>\r\n                                        <th className=\"px-4 py-2 text-right text-lg\">\r\n                                            {totals.net_amount.toFixed(3)}\r\n                                        </th>\r\n                                    </tr>\r\n                                </tfoot>\r\n                            </table>\r\n                        </div>\r\n\r\n                        <hr />\r\n\r\n                        {/* Remark */}\r\n                        <FormField\r\n                            control={form.control}\r\n                            name=\"remark\"\r\n                            render={({ field }) => (\r\n                                <FormItem>\r\n                                    <FormLabel>Remark</FormLabel>\r\n                                    <FormControl>\r\n                                        <Input placeholder=\"Remark\" {...field} />\r\n                                    </FormControl>\r\n                                </FormItem>\r\n                            )}\r\n                        />\r\n\r\n                        {/* Action Buttons */}\r\n                        <div className=\"flex justify-between items-center pt-4 border-t\">\r\n                            <Button type=\"button\" variant=\"outline\" className=\"bg-teal-600 text-white hover:bg-teal-700\">\r\n                                Terms & Conditions (0)\r\n                            </Button>\r\n\r\n                            <div className=\"flex gap-3\">\r\n                                <Button\r\n                                    type=\"button\"\r\n                                    variant=\"outline\"\r\n                                    onClick={() => onOpenChange(false)}\r\n                                    disabled={isSaving}\r\n                                >\r\n                                    <X className=\"mr-2 h-4 w-4\" />\r\n                                    Cancel\r\n                                </Button>\r\n                                <Button\r\n                                    type=\"submit\"\r\n                                    disabled={isSaving}\r\n                                    className=\"bg-green-600 hover:bg-green-700\"\r\n                                >\r\n                                    <Save className=\"mr-2 h-4 w-4\" />\r\n                                    {isSaving ? 'Saving...' : 'Save'}\r\n                                </Button>\r\n                            </div>\r\n                        </div>\r\n                    </form>\r\n                </Form>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\pivotbearings-erp\\src\\hooks\\usePurchaseOrders.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":52,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1489,1492],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1489,1492],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":79,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2178,2181],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2178,2181],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":111,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3267,3270],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3267,3270],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":126,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3790,3793],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3790,3793],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":138,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":138,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4174,4177],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4174,4177],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":164,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":164,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5110,5113],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5110,5113],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":184,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":184,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5778,5781],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5778,5781],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":197,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":197,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6201,6204],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6201,6204],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":209,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":209,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6705,6708],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6705,6708],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":219,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":219,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7011,7014],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7011,7014],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":232,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":232,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7526,7529],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7526,7529],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":246,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":246,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7980,7983],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7980,7983],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":255,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":255,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8390,8393],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8390,8393],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":267,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":267,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8826,8829],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8826,8829],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":276,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":276,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9148,9151],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9148,9151],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":288,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":288,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9541,9544],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9541,9544],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":295,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":295,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9857,9860],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9857,9860],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":309,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":309,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10258,10261],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10258,10261],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":18,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useDistributorId } from '@/hooks/useDistributorProfile';\r\nimport { toast } from 'sonner';\r\n\r\nexport interface PurchaseOrderItem {\r\n    id?: string;\r\n    purchase_order_id?: string;\r\n    item_id: string | null;\r\n    item_name: string;\r\n    hsn_code: string;\r\n    quantity: number;\r\n    unit: string;\r\n    price: number;\r\n    discount_percent: number;\r\n    discount_amount: number;\r\n    gst_percent: number;\r\n    cgst_percent: number;\r\n    sgst_percent: number;\r\n    igst_percent: number;\r\n    cgst_amount: number;\r\n    sgst_amount: number;\r\n    igst_amount: number;\r\n    taxable_amount: number;\r\n    net_amount: number;\r\n    remark: string;\r\n    sort_order: number;\r\n}\r\n\r\nexport interface PurchaseOrder {\r\n    id: string;\r\n    distributor_id: string;\r\n    po_prefix: string;\r\n    po_number: number;\r\n    po_full_number: string;\r\n    po_date: string;\r\n    party_id: string;\r\n    party_gstin: string | null;\r\n    transport_name: string | null;\r\n    contact_person: string | null;\r\n    contact_number: string | null;\r\n    delivery_address: string | null;\r\n    taxable_amount: number;\r\n    cgst_amount: number;\r\n    sgst_amount: number;\r\n    igst_amount: number;\r\n    round_off_amount: number;\r\n    net_amount: number;\r\n    gst_type: number;\r\n    status: 'pending' | 'completed' | 'cancelled';\r\n    remark: string | null;\r\n    terms_conditions: any[];\r\n    created_at: string;\r\n    updated_at: string;\r\n    // Joined data\r\n    party_name?: string;\r\n    items?: PurchaseOrderItem[];\r\n}\r\n\r\nexport interface CreatePurchaseOrderData {\r\n    po_prefix: string;\r\n    po_number: number;\r\n    po_full_number: string;\r\n    po_date: string;\r\n    party_id: string;\r\n    party_gstin?: string;\r\n    transport_name?: string;\r\n    contact_person?: string;\r\n    contact_number?: string;\r\n    delivery_address?: string;\r\n    taxable_amount: number;\r\n    cgst_amount: number;\r\n    sgst_amount: number;\r\n    igst_amount: number;\r\n    round_off_amount: number;\r\n    net_amount: number;\r\n    gst_type: number;\r\n    remark?: string;\r\n    terms_conditions?: any[];\r\n    items: Omit<PurchaseOrderItem, 'id' | 'purchase_order_id'>[];\r\n}\r\n\r\n// Get current financial year prefix (e.g., \"PO/25-26/\")\r\nexport function getCurrentFYPrefix(): string {\r\n    const now = new Date();\r\n    const year = now.getFullYear();\r\n    const month = now.getMonth() + 1; // 0-indexed\r\n\r\n    // Financial year starts in April\r\n    if (month >= 4) {\r\n        const startYear = year % 100;\r\n        const endYear = (year + 1) % 100;\r\n        return `PO/${startYear}-${endYear}/`;\r\n    } else {\r\n        const startYear = (year - 1) % 100;\r\n        const endYear = year % 100;\r\n        return `PO/${startYear}-${endYear}/`;\r\n    }\r\n}\r\n\r\nexport function usePurchaseOrders() {\r\n    const { data: distributorId } = useDistributorId();\r\n    const queryClient = useQueryClient();\r\n\r\n    // Fetch all purchase orders\r\n    const { data: purchaseOrders = [], isLoading, refetch } = useQuery({\r\n        queryKey: ['purchase_orders', distributorId],\r\n        queryFn: async () => {\r\n            if (!distributorId) return [];\r\n\r\n            const { data, error } = await (supabase as any)\r\n                .from('purchase_orders')\r\n                .select(`\r\n                    *,\r\n                    parties:party_id (name)\r\n                `)\r\n                .eq('distributor_id', distributorId)\r\n                .order('po_date', { ascending: false })\r\n                .order('po_number', { ascending: false });\r\n\r\n            if (error) {\r\n                console.error('Error fetching purchase orders:', error);\r\n                return [];\r\n            }\r\n\r\n            return (data || []).map((po: any) => ({\r\n                ...po,\r\n                party_name: po.parties?.name || 'Unknown',\r\n            })) as PurchaseOrder[];\r\n        },\r\n        enabled: !!distributorId,\r\n    });\r\n\r\n    // Get next PO number\r\n    const getNextPoNumber = async (prefix: string): Promise<number> => {\r\n        if (!distributorId) return 1;\r\n\r\n        const { data, error } = await (supabase as any)\r\n            .rpc('get_next_po_number', {\r\n                p_distributor_id: distributorId,\r\n                p_prefix: prefix,\r\n            });\r\n\r\n        if (error) {\r\n            console.error('Error getting next PO number:', error);\r\n            // Fallback: manually calculate\r\n            const existing = purchaseOrders.filter(po => po.po_prefix === prefix);\r\n            return existing.length > 0\r\n                ? Math.max(...existing.map(po => po.po_number)) + 1\r\n                : 1;\r\n        }\r\n\r\n        return data || 1;\r\n    };\r\n\r\n    // Create purchase order\r\n    const createPurchaseOrder = useMutation({\r\n        mutationFn: async (orderData: CreatePurchaseOrderData) => {\r\n            if (!distributorId) throw new Error('Distributor not found');\r\n\r\n            const { items, ...headerData } = orderData;\r\n\r\n            // Insert header\r\n            const { data: poData, error: poError } = await (supabase as any)\r\n                .from('purchase_orders')\r\n                .insert({\r\n                    distributor_id: distributorId,\r\n                    ...headerData,\r\n                    status: 'pending',\r\n                })\r\n                .select()\r\n                .single();\r\n\r\n            if (poError) throw poError;\r\n\r\n            // Insert items\r\n            if (items.length > 0) {\r\n                const itemsWithPoId = items.map((item, index) => ({\r\n                    ...item,\r\n                    purchase_order_id: poData.id,\r\n                    sort_order: index,\r\n                }));\r\n\r\n                const { error: itemsError } = await (supabase as any)\r\n                    .from('purchase_order_items')\r\n                    .insert(itemsWithPoId);\r\n\r\n                if (itemsError) throw itemsError;\r\n            }\r\n\r\n            return poData;\r\n        },\r\n        onSuccess: () => {\r\n            queryClient.invalidateQueries({ queryKey: ['purchase_orders'] });\r\n            toast.success('Purchase Order created successfully');\r\n        },\r\n        onError: (error: any) => {\r\n            console.error('Error creating purchase order:', error);\r\n            toast.error(`Failed to create purchase order: ${error.message}`);\r\n        },\r\n    });\r\n\r\n    // Update purchase order\r\n    const updatePurchaseOrder = useMutation({\r\n        mutationFn: async ({ id, data }: { id: string; data: Partial<CreatePurchaseOrderData> }) => {\r\n            const { items, ...headerData } = data;\r\n\r\n            // Update header\r\n            const { error: poError } = await (supabase as any)\r\n                .from('purchase_orders')\r\n                .update(headerData)\r\n                .eq('id', id);\r\n\r\n            if (poError) throw poError;\r\n\r\n            // Update items if provided\r\n            if (items) {\r\n                // Delete existing items\r\n                await (supabase as any)\r\n                    .from('purchase_order_items')\r\n                    .delete()\r\n                    .eq('purchase_order_id', id);\r\n\r\n                // Insert new items\r\n                if (items.length > 0) {\r\n                    const itemsWithPoId = items.map((item, index) => ({\r\n                        ...item,\r\n                        purchase_order_id: id,\r\n                        sort_order: index,\r\n                    }));\r\n\r\n                    const { error: itemsError } = await (supabase as any)\r\n                        .from('purchase_order_items')\r\n                        .insert(itemsWithPoId);\r\n\r\n                    if (itemsError) throw itemsError;\r\n                }\r\n            }\r\n\r\n            return { id };\r\n        },\r\n        onSuccess: () => {\r\n            queryClient.invalidateQueries({ queryKey: ['purchase_orders'] });\r\n            toast.success('Purchase Order updated successfully');\r\n        },\r\n        onError: (error: any) => {\r\n            console.error('Error updating purchase order:', error);\r\n            toast.error(`Failed to update purchase order: ${error.message}`);\r\n        },\r\n    });\r\n\r\n    // Update status only\r\n    const updateStatus = useMutation({\r\n        mutationFn: async ({ id, status }: { id: string; status: 'pending' | 'completed' | 'cancelled' }) => {\r\n            const { error } = await (supabase as any)\r\n                .from('purchase_orders')\r\n                .update({ status })\r\n                .eq('id', id);\r\n\r\n            if (error) throw error;\r\n            return { id, status };\r\n        },\r\n        onSuccess: (_, variables) => {\r\n            queryClient.invalidateQueries({ queryKey: ['purchase_orders'] });\r\n            toast.success(`Purchase Order marked as ${variables.status}`);\r\n        },\r\n        onError: (error: any) => {\r\n            toast.error(`Failed to update status: ${error.message}`);\r\n        },\r\n    });\r\n\r\n    // Delete purchase order\r\n    const deletePurchaseOrder = useMutation({\r\n        mutationFn: async (id: string) => {\r\n            // Items are deleted via CASCADE\r\n            const { error } = await (supabase as any)\r\n                .from('purchase_orders')\r\n                .delete()\r\n                .eq('id', id);\r\n\r\n            if (error) throw error;\r\n            return id;\r\n        },\r\n        onSuccess: () => {\r\n            queryClient.invalidateQueries({ queryKey: ['purchase_orders'] });\r\n            toast.success('Purchase Order deleted successfully');\r\n        },\r\n        onError: (error: any) => {\r\n            toast.error(`Failed to delete purchase order: ${error.message}`);\r\n        },\r\n    });\r\n\r\n    // Get single purchase order with items\r\n    const getPurchaseOrderWithItems = async (id: string): Promise<PurchaseOrder | null> => {\r\n        const { data: po, error: poError } = await (supabase as any)\r\n            .from('purchase_orders')\r\n            .select(`\r\n                *,\r\n                parties:party_id (name)\r\n            `)\r\n            .eq('id', id)\r\n            .single();\r\n\r\n        if (poError) {\r\n            console.error('Error fetching purchase order:', poError);\r\n            return null;\r\n        }\r\n\r\n        const { data: items, error: itemsError } = await (supabase as any)\r\n            .from('purchase_order_items')\r\n            .select('*')\r\n            .eq('purchase_order_id', id)\r\n            .order('sort_order', { ascending: true });\r\n\r\n        if (itemsError) {\r\n            console.error('Error fetching purchase order items:', itemsError);\r\n        }\r\n\r\n        return {\r\n            ...po,\r\n            party_name: po.parties?.name || 'Unknown',\r\n            items: items || [],\r\n        };\r\n    };\r\n\r\n    return {\r\n        purchaseOrders,\r\n        isLoading,\r\n        refetch,\r\n        getNextPoNumber,\r\n        createPurchaseOrder,\r\n        updatePurchaseOrder,\r\n        updateStatus,\r\n        deletePurchaseOrder,\r\n        getPurchaseOrderWithItems,\r\n    };\r\n}\r\n\r\n// Hook to get suppliers only (party_type = 'supplier' or 'both')\r\nexport function useSuppliers() {\r\n    const { data: distributorId } = useDistributorId();\r\n\r\n    const { data: suppliers = [], isLoading } = useQuery({\r\n        queryKey: ['suppliers', distributorId],\r\n        queryFn: async () => {\r\n            if (!distributorId) return [];\r\n\r\n            const { data, error } = await supabase\r\n                .from('parties')\r\n                .select('id, name, gstin, city, state_code')\r\n                .eq('distributor_id', distributorId)\r\n                .in('party_type', ['supplier', 'both'])\r\n                .eq('is_active', true)\r\n                .order('name');\r\n\r\n            if (error) {\r\n                console.error('Error fetching suppliers:', error);\r\n                return [];\r\n            }\r\n\r\n            return data || [];\r\n        },\r\n        enabled: !!distributorId,\r\n    });\r\n\r\n    return { suppliers, isLoading };\r\n}\r\n","usedDeprecatedRules":[]}]
